#!/usr/bin/env bash
# Configures nginx to show a custom 404 page containing "Ceci n'est pas une page"

set -e

NGINX_CONF="/etc/nginx/sites-available/default"
NOTFOUND="/var/www/html/404.html"
MSG="Ceci n'est pas une page"

# 1. Install nginx if not already
if ! dpkg -s nginx >/dev/null 2>&1; then
	  apt-get update -y
	    apt-get install -y nginx
fi

# 2. Create the required 404 page
echo "$MSG" > "$NOTFOUND"

# 3. Remove any existing error_page config (idempotent)
sed -i '/error_page 404 \/404.html;/d' "$NGINX_CONF"

# 4. Insert error_page inside the server block before the last }
awk -v epage="    error_page 404 /404.html;\n" '
  BEGIN {in_server=0}
    /^server[ \t]*{/ {in_server=1}
      in_server && /^\}/     {print epage; in_server=0}
        {print}
	' "$NGINX_CONF" > /tmp/default.conf && mv /tmp/default.conf "$NGINX_CONF"

	# 5. Reload nginx
	nginx -t
	service nginx restart
