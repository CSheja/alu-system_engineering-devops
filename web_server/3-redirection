#!/usr/bin/env bash
# Configures Nginx on a fresh Ubuntu machine to redirect /redirect_me to a given URL with HTTP 301

# Exit immediately if any command fails
set -e

# Update package list and install nginx if not installed
apt-get update -y
apt-get install -y nginx

# Ensure the default site config exists
CONFIG_FILE="/etc/nginx/sites-available/default"

# Backup current config just in case
cp $CONFIG_FILE "${CONFIG_FILE}.bak"

# Remove any existing /redirect_me block and add the correct one
# This sed command deletes old /redirect_me blocks
sed -i '/location \/redirect_me {/,/}/d' $CONFIG_FILE

# Add the /redirect_me redirect inside the server block
sed -i '/server_name _;/a \\n\tlocation /redirect_me {\n\t\treturn 301 https://www.youtube.com/watch?v=QH2-TGUlwu4;\n\t}' $CONFIG_FILE

# Test nginx config syntax
nginx -t

# Restart nginx to apply changes
systemctl restart nginx
